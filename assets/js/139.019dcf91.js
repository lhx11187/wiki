(window.webpackJsonp=window.webpackJsonp||[]).push([[139],{494:function(t,e,s){"use strict";s.r(e);var a=s(42),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"ocserv"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ocserv"}},[t._v("#")]),t._v(" ocserv")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://gitlab.com/openconnect/recipes",target:"_blank",rel:"noopener noreferrer"}},[t._v("recipes"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://openconnect.github.io/openconnect-gui/",target:"_blank",rel:"noopener noreferrer"}},[t._v("openconnect-gui"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://download.escope.net/Cisco/asa/vpn/",target:"_blank",rel:"noopener noreferrer"}},[t._v("AnyConnect"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://www.vps000.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("威伯斯云"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://v2ex.com/t/665868",target:"_blank",rel:"noopener noreferrer"}},[t._v("配置不代理局域网"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/CNMan/ocserv-cn-no-route",target:"_blank",rel:"noopener noreferrer"}},[t._v("ocserv-cn-no-route"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://yuerblog.cc/2020/11/21/%e5%ae%b6%e5%ba%ad%e6%90%ad%e5%bb%baopenconnect-vpn/",target:"_blank",rel:"noopener noreferrer"}},[t._v("家庭搭建openconnect vpn"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://beijing.bb/splitting-network-traffic-based-on-destinations/",target:"_blank",rel:"noopener noreferrer"}},[t._v("野生思科分离隧道"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://www.ioiox.com/archives/90.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("OpenWRT 路由器 OpenConnect VPN 详细图文教程"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://www.petenetlive.com/KB/Article/0000546",target:"_blank",rel:"noopener noreferrer"}},[t._v("VPN establishment capability for a remote user"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://blog.expta.com/2020/04/how-to-enable-cisco-anyconnect-vpn.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("through Remote Desktop"),s("OutboundLink")],1)])]),t._v(" "),s("p",[s("strong",[t._v("安装")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" update\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" ocserv\n")])])]),s("p",[s("strong",[t._v("ssl证书")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /root/certificates\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /root/certificates\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ca")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tee")]),t._v(" /root/certificates/ca.tmpl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<-")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'EOF\'\ncn = "HX CA"\norganization = "HX"\nserial = 1\nexpiration_days = 3650\nca\nsigning_key\ncert_signing_key\ncrl_signing_key\nEOF')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# user")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tee")]),t._v(" /root/certificates/user.tmpl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<-")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'EOF\'\ncn = "huxins"\nunit = "HX"\nexpiration_days = 3650\nsigning_key\ntls_www_client\nEOF')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# server")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tee")]),t._v(" /root/certificates/server.tmpl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<-")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'EOF\'\ncn = "a sever\'s name, usually matches hostname"\norganization = "your organization"\nserial = 2\nexpiration_days = 3650\nsigning_key\nencryption_key\ntls_www_server\ndns_name = "your organization\'s host name"\n#ip_address = "if no hostname uncomment and set the IP address here"\nEOF')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 生成CA证书")]),t._v("\ncerttool --generate-privkey --outfile ca-key.pem\ncerttool --generate-self-signed --hash SHA256 --load-privkey ca-key.pem --template ca.tmpl --outfile ca-cert.pem\ncerttool -i --infile ca-cert.pem\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 生成 Diffie-Hellman 密钥")]),t._v("\ncerttool --generate-dh-params --outfile /etc/ocserv/ssl/dh.pem\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# CA签发VPN证书")]),t._v("\ncerttool --generate-privkey --outfile server-key.pem\ncerttool --generate-certificate --hash SHA256 --load-privkey server-key.pem --load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem --template server.tmpl --outfile server-cert.pem\ncerttool -i --infile user-cert.pem\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# CA签发用户证书")]),t._v("\ncerttool --generate-privkey --outfile user-key.pem\ncerttool --generate-certificate --hash SHA256 --load-privkey user-key.pem --load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem --template user.tmpl --outfile user-cert.pem\ncerttool -i --infile user-cert.pem\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 证书链补全")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" /root/certificates/ca-cert.pem "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" /root/certificates/user-cert.pem\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 生成.p12证书文件")]),t._v("\nopenssl pkcs12 -export -inkey user-key.pem -in user-cert.pem -name "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"huxins"')]),t._v(" -certfile ca-cert.pem -caname "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"HX CA"')]),t._v(" -out huxins.AnyConnect.p12 -passout pass:12345678\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 把VPN证书拷到ocserv配置目录下")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" server-cert.pem server-key.pem /etc/ocserv/\n")])])]),s("p",[s("strong",[t._v("配置")])]),t._v(" "),s("p",[t._v("/etc/ocserv/ocserv.conf")]),t._v(" "),s("div",{staticClass:"language-ini extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("auth")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(' "certificate"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ca-cert")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" /etc/ocserv/ca-cert.pem")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("cert-user-oid")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 2.5.4.3")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("server-cert")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" /etc/ocserv/server-cert.pem")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("server-key")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" /etc/ocserv/server-key.pem")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("tcp-port")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 443")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("udp-port")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 443")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ipv4-network")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 192.168.8.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ipv4-netmask")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 255.255.255.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("dns")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 8.8.8.8")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("no-route")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 172.26.201.0/255.255.255.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("route")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 192.168.11.0/255.255.255.0")]),t._v("\n")])])]),s("p",[s("strong",[t._v("创建VPN用户")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("ocpasswd -c /etc/ocserv/ocpasswd myvpnuser\n")])])]),s("p",[s("strong",[t._v("VPN拨号")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" /etc/openconnect/password"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" openconnect -b https://YourORGVPNURL -u YourOrgVPNUsername --passwd-on-stdin\n")])])]),s("p",[s("strong",[t._v("VPN服务")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("ocserv -c /etc/ocserv/ocserv.conf -f -d "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])]),s("p",[s("strong",[t._v("防火墙")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("iptables -t nat -I POSTROUTING -s "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".100.0/24 -j MASQUERADE\niptables -I FORWARD -i vpns+ -s "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".100.0/24 -j ACCEPT\niptables -I INPUT -i vpns+ -s "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".100.0/24 -j ACCEPT\n\nfirewall-cmd --permanent --zone"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("public --add-port"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/tcp\nfirewall-cmd --permanent --zone"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("public --add-port"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/udp\nfirewall-cmd --permanent --add-masquerade\nfirewall-cmd --permanent --direct --passthrough ipv4 -t nat -A POSTROUTING -o ens34 -j MASQUERADE\nfirewall-cmd --reload\n")])])])])}),[],!1,null,null,null);e.default=n.exports}}]);