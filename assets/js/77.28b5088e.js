(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{433:function(s,a,t){"use strict";t.r(a);var e=t(42),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"ssh"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ssh"}},[s._v("#")]),s._v(" ssh")]),s._v(" "),t("h2",{attrs:{id:"login"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#login"}},[s._v("#")]),s._v(" login")]),s._v(" "),t("p",[s._v("免输入 yes")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("StrictHostKeyChecking no\n")])])]),t("p",[s._v("免除 known_hosts 更新")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("UserKnownHostsFile /dev/null\n")])])]),t("p",[s._v("删除 known_hosts")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ssh-keygen -R "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v("\n")])])]),t("p",[s._v("免密码登入")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ssh-copy-id user@host\n")])])]),t("p",[s._v("口令登录")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("PasswordAuthentication "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n")])])]),t("p",[s._v("允许 root 用户远程登录")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("PermitRootLogin "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n")])])]),t("p",[s._v("安装 sshd")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" openssh-server\n")])])]),t("h2",{attrs:{id:"secret-key"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#secret-key"}},[s._v("#")]),s._v(" secret key")]),s._v(" "),t("p",[s._v("生成密钥")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ～/.ssh\nssh-keygen -t rsa -C "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"huxins@163.com"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试与目标服务器连接")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -T git@github.com\n")])])]),t("h2",{attrs:{id:"agent"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#agent"}},[s._v("#")]),s._v(" agent")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/57630633",target:"_blank",rel:"noopener noreferrer"}},[s._v("SSH 命令的三种代理功能（-L/-R/-D）"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://blog.hanxi.info/?p=8",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用 ssh 借助外网机器实现内网穿透实现远程登录"),t("OutboundLink")],1)])]),s._v(" "),t("p",[t("code",[s._v("SSH")]),s._v(" 命令除了登陆外还有三种代理功能：")]),s._v(" "),t("ul",[t("li",[s._v("正向代理（-L）：相当于 iptable 的 port forwarding")]),s._v(" "),t("li",[s._v("反向代理（-R）：相当于 frp 或者 ngrok")]),s._v(" "),t("li",[s._v("socks5 代理（-D）：相当于 ss/ssr")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正向代理")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -L "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:PortA:HostB:PortB user@HostB\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 反向代理")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 HostB 上配置 /etc/ssh/sshd_config")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# GatewayPorts yes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -R HostB:PortB:HostA:PortA user@HostB\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Socks5")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -D localhost:1080 user@HostB\n")])])]),t("p",[t("strong",[s._v("优化")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -CqTnN -L "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:PortA:HostB:PortB  user@HostB\n")])])]),t("p",[s._v("其中 "),t("code",[s._v("-C")]),s._v(" 为压缩数据，"),t("code",[s._v("-q")]),s._v(" 安静模式，"),t("code",[s._v("-T")]),s._v(" 禁止远程分配终端，"),t("code",[s._v("-n")]),s._v(" 关闭标准输入，"),t("code",[s._v("-N")]),s._v(" 不执行远程命令。此外视需要还可以增加 "),t("code",[s._v("-f")]),s._v(" 参数，把 ssh 放到后台运行。")]),s._v(" "),t("p",[s._v("这些 ssh 代理没有断线重连功能，链接断了命令就退出了，所以需要些脚本监控重启，或者使用 autossh 之类的工具保持链接。")]),s._v(" "),t("p",[t("strong",[s._v("防止连接断开")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ip")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.1\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cport")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$((")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$RANDOM")]),s._v(" % "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("mport")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cmd")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ssh -p'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port")]),s._v(" -f -N -R "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cport")]),s._v(":localhost:"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$mport")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$user")]),s._v("@"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ip")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("reg")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ssh -p'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port")]),s._v(" -f -N -R [0-9]\\{4\\}:localhost:"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$mport")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$user")]),s._v("@"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ip")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("isrun")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -ef "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$reg")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -v "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$isrun")]),s._v('"')]),s._v("x "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"x"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"notrun"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cmd")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cmd")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"isrun"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$isrun")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])])]),t("p",[t("strong",[s._v("autossh")])]),s._v(" "),t("ul",[t("li",[t("code",[s._v("-M 20001")]),s._v(" 选项指定中继服务器上的监视端口，用于交换监视 SSH 会话的测试数据。")]),s._v(" "),t("li",[t("code",[s._v("-o")]),s._v(" 用于设置 autossh 参数。")]),s._v(" "),t("li",[t("code",[s._v("-f")]),s._v(" 指定 autossh 在后台运行，并不会传给 ssh。和 ssh 的 "),t("code",[s._v("-f")]),s._v(" 不一样，autossh 指定 "),t("code",[s._v("-f")]),s._v(" 时将无法寻求密码。指定 "),t("code",[s._v("-f")]),s._v(" 时，会将环境变量 "),t("code",[s._v("AUTOSSH_GATETIME")]),s._v(" 覆盖为 0！")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("autossh -M "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-fN -o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"PubkeyAuthentication=yes"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"StrictHostKeyChecking=no"')]),s._v(" -o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ServerAliveInterval 60"')]),s._v(" -o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ServerAliveCountMax 3"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-L "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:PortA:HostB:PortB "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" remote_user@HostB\n")])])]),t("p",[s._v("开机启动")]),s._v(" "),t("div",{staticClass:"language-ini extra-class"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token selector"}},[s._v("[Unit]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Description")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("AutoSSH service for remote tunnel")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("After")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("network-online.target")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token selector"}},[s._v("[Service]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("User")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("your_username")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ExecStart")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v('/usr/bin/autossh -M 20001 -N -o "PubkeyAuthentication=yes" -o "StrictHostKeyChecking=no" -o "ServerAliveInterval 60" -o "ServerAliveCountMax 3" -R HostA:PortA:HostB:PortB -p 8383 remote_user@HostB')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token selector"}},[s._v("[Install]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("WantedBy")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("multi-user.target")]),s._v("\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);